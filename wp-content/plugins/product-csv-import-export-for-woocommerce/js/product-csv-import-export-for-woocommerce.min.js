jQuery(document).ready(function (a) {
    "use strict";
    a("#v_start_date").datepicker({
        dateFormat: "yy-mm-dd",
        numberOfMonths: 1,
        showButtonPanel: !0,
        showOn: "button",
        buttonImage: woocommerce_product_csv_import_params.calendar_icon,
        buttonImageOnly: !0
    }), a("#v_end_date").datepicker({
        dateFormat: "yy-mm-dd",
        numberOfMonths: 1,
        showButtonPanel: !0,
        showOn: "button",
        buttonImage: woocommerce_product_csv_import_params.calendar_icon,
        buttonImageOnly: !0
    }),
    a("#pro_enable_ftp_ie").click(function () {
        if (this.checked) {
            a("#pro_export_section_all").show();
        } else {
            a("#pro_export_section_all").hide();
        }
    });
    a("select[name=pro_auto_export]").change(function () {
        if ("Disabled" === a(this).val()) {
            a(".pro_export_section").hide();
        } else {
            a(".pro_export_section").show();
        }
    });

    if (woocommerce_product_csv_cron_params.pro_enable_ftp_ie != 1) {
        a("#pro_export_section_all").hide();
    }
    ;
    if (woocommerce_product_csv_cron_params.pro_auto_export === 'Disabled') {
        a(".pro_export_section").hide();
    }
    ;
    a("select[name=pro_auto_import]").change(function () {
        if ("Disabled" === a(this).val()) {
            a(".pro_import_section").hide();
        } else {
            a(".pro_import_section").show();
        }
    });
    if (woocommerce_product_csv_cron_params.pro_auto_import === 'Disabled') {
        a(".pro_import_section").hide();
    }
    if (woocommerce_product_csv_cron_params.pro_enable_url_ie != 1) {
        a("#pro_import_from_url_section_all").hide();
    }
    a("#pro_enable_url_ie").click(function () {
        if (this.checked) {
            a("#pro_import_from_url_section_all").show();
        } else {
            a("#pro_import_from_url_section_all").hide();
        }
    });
    
    
    

    // Listen for click on toggle checkbox
    a('#pselectall').live("click", function () {
        // Iterate each checkbox
        a('#datagrid :checkbox').each(function () {
            this.checked = true;
        });
    });
    a('#punselectall').live("click", function () {
        // Iterate each checkbox
        a('#datagrid :checkbox').each(function () {
            this.checked = false;
        });
    });
    a("select[name=export_profile]").change(function () {

        var selected_profile = this.value;
        a("#v_new_profile").val(selected_profile);
        var data = {
            action: 'product_csv_export_mapping_change',
            v_new_profile: selected_profile,
        };
        a.ajax({
            url: woocommerce_product_csv_import_params.siteurl + '?page=wf_woocommerce_csv_im_ex',
            data: data,
            type: 'POST',
            success: function (response) {
                a("#datagrid").html(response);
            }});
    });


//    a("#pro_enable_url_ie").click(function () {
//        alert(123);
//        if (this.checked) {
//            a("#pro_import_from_url_section_all").show();
//        } else {
//            a("#pro_import_from_url_section_all").hide();
//        }
//    });
//    if (woocommerce_product_csv_cron_params_url.pro_enable_url_ie != 1) {
//        a("#pro_import_from_url_section_all").hide();
//    }
//    ;

});

jQuery(document).ready(function () {
    jQuery('.export_images_zip_carry').hide();
    jQuery("select[name=v_export_images_zip]").change(function () {
        if (this.value == 1) {
            jQuery('.export_images_zip_carry').show();
            jQuery('.export_images_zip_carry_msg_no').hide();

        } else {
            jQuery('.export_images_zip_carry').hide();
            jQuery('.export_images_zip_carry_msg_no').show();
        }
    });

    jQuery('#export_images_zip_button').click(function () {
        if (jQuery("select[name=v_export_images_zip]").val() == 1) {
            window.open(woocommerce_product_csv_import_params.siteurl + '?page=wf_woocommerce_csv_im_ex&action=export_images', '_blank')
        }
    });
    
    
    
    jQuery("#v_save_export_mapping").click(function () {  
        var profile_name = jQuery("input[name='new_profile']").val();
        if(profile_name==''){
            alert(woocommerce_product_csv_import_params.profile_empty_msg);
            return false;
        }
        jQuery('.spinner').addClass('is-active');
        var columns = jQuery("input[name*='columns[']").serializeArray();
        var columns_name = jQuery("input[name*='columns_name[']").serializeArray();        
        var data = {
            action: 'product_csv_export_mapping_save',
            profile_name: profile_name,
            columns: columns,
            columns_name: columns_name,
        };
        jQuery.ajax({
            url: woocommerce_product_csv_import_params.siteurl + '?page=wf_woocommerce_csv_im_ex',
            data: data,
            type: 'POST',
            
            success : function(response){
			jQuery('.spinner').removeClass('is-active');
			jQuery('#prod_save_mapping_msg').remove();
			jQuery('#prod_save_mapping_notice').prepend(response);
			jQuery("#prod_save_mapping_msg").delay(8000).fadeOut(300);
		}
            });
    });
    
    jQuery("#v_save_import_mapping").click(function () {  
        var profile_name = jQuery("input[name='profile']").val();
        if(profile_name==''){
            alert(woocommerce_product_csv_import_params.profile_empty_msg);
            return false;
        }
        jQuery('.spinner').addClass('is-active');
        
        var map_from = jQuery("select[name*='map_from[']").serializeArray();
        var eval_field = jQuery("input[name*='eval_field[']").serializeArray();   
        var data = {
            action: 'product_csv_import_mapping_save',
            profile_name: profile_name,
            map_from: map_from,
            eval_field: eval_field,
            
        };
        jQuery.ajax({
            url: woocommerce_product_csv_import_params.siteurl + '?page=wf_woocommerce_csv_im_ex',
            data: data,
            type: 'POST',
            
            success : function(response){
			jQuery('.spinner').removeClass('is-active');
			jQuery('#prod_save_mapping_msg').remove();
			jQuery('#prod_save_mapping_notice').prepend(response);
			jQuery("#prod_save_mapping_msg").delay(8000).fadeOut(300);
		}
            });
    });
    
    jQuery("#v_delete_export_mapping").click(function () {  
        var profile_name = jQuery("select[name='export_profile']").val();
        
        if(profile_name==''){
            alert(woocommerce_product_csv_import_params.profile_choose_empty_msg);
            return false;
        }
        jQuery('.delete.spinner').addClass('is-active');
        var data = {
            action: 'product_csv_export_mapping_delete',
            profile_name: profile_name,

        };
        jQuery.ajax({
            url: woocommerce_product_csv_import_params.siteurl + '?page=wf_woocommerce_csv_im_ex',
            data: data,
            type: 'POST',
            
            success : function(response){
			jQuery('.spinner').removeClass('is-active');
			jQuery('#prod_delete_mapping_msg').remove();
			jQuery('#prod_delete_mapping_notice').prepend(response);
			jQuery("#prod_delete_mapping_msg").delay(8000).fadeOut(300);
		}
            });
    });
        
});



;(function ( $, window ) {

	var productExportForm = function( $form ) {
		this.$form = $form;
		this.xhr   = false;

		this.$form.find('.wt-batch-exporter-progress').val( 0 );

		this.processStep = this.processStep.bind( this );

		$form.on( 'submit', { productExportForm: this }, this.onSubmit );
	};


	productExportForm.prototype.onSubmit = function( event ) {
		event.preventDefault();

		var currentDate    = new Date(),
			day            = currentDate.getDate(),
			month          = currentDate.getMonth() + 1,
			year           = currentDate.getFullYear(),
			timestamp      = currentDate.getTime(),
			filename       = 'wt-product-export-' + day + '-' + month + '-' + year + '-' + timestamp + '.csv';

		event.data.productExportForm.$form.addClass( 'wt-batch-exporter-exporting' );
		event.data.productExportForm.$form.find('.wt-batch-exporter-progress').val( 0 );
		event.data.productExportForm.$form.find('.wt-batch-exporter-button').prop( 'disabled', true );
                event.data.productExportForm.$form.find('.spinner').addClass('is-active');
		event.data.productExportForm.processStep( 1, $( this ).serialize(), '', filename );
	};

	/**
	 * Process the current export step.
	 */
	productExportForm.prototype.processStep = function( step, data, columns, filename ) {
                var $this         = this,
                //selected_columns = $( '.wt-batch-exporter-columns' ).val(),
                export_meta      = $( '#v_include_hidden_meta:checked' ).length ? 1: 0;
                var columns      = jQuery("input[name*='columns[']").serializeArray();
                var columns_name = jQuery("input[name*='columns_name[']").serializeArray(); 
                var batch_count  = $( '#v_batch_count' ).val();
                 
		$.ajax( {
			type: 'POST',
			url: ajaxurl,
			data: {
				form             : data,
				action           : 'wt_batch_product_export',
				step             : step,
				//selected_columns : selected_columns,
                                columns: columns,
                                columns_name: columns_name,
				include_hidden_meta      : export_meta,
				filename         : filename,
                                batch_count      : batch_count,
				security         : wt_batch_export_params.wt_export_nonce
			},
			dataType: 'json',
			success: function( response ) {
				if ( response.success ) {
					if ( 'done' === response.data.step ) {
						$this.$form.find('.wt-batch-exporter-progress').val( response.data.percentage );
						window.location = response.data.url;
						setTimeout( function() {
							$this.$form.removeClass( 'wt-batch-exporter-exporting' );
							$this.$form.find('.wt-batch-exporter-button').prop( 'disabled', false );
                                                        $this.$form.find('.spinner').removeClass('is-active');
						}, 2000 );
					} else {
						$this.$form.find('.wt-batch-exporter-progress').val( response.data.percentage );
						$this.processStep( parseInt( response.data.step, 10 ), data, response.data.columns, filename );
					}
				}


			}
		} ).fail( function( response ) {
			window.console.log( response );
		} );
	};

	$.fn.wc_product_export_form = function() {

		new productExportForm( this );
		return this;
	};

	$( '.wt-batch-exporter' ).wc_product_export_form();

})( jQuery, window );